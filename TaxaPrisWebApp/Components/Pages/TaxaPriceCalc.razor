@page "/TaxaPriceCalc";
@using TaxaPrisWebApp.Services
@using System.Collections.Generic
@using TaxaPrisWebApp.Model
@inject Services.TaxaService TaxaService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

@* form start *@
<form>
    <h4>Vælg vogn:</h4>

    @* table *@
    @* data is retrieved from Taxapris.json *@
    <table width="100%" height="200px">

        @* first row *@
        <tr>
            @* first row, first column *@
            @* choose car drop down menu *@
            <td valign="top" width="15%" height="20px">
                <br />Vogntype<br />
                <select @onchange="HandleCarChange">
                    <option value="1">[Vælg vogn]</option>
                    <option value="1">Almindelig Vogn</option>
                    <option value="3">Stor Vogn</option>
                </select>
            </td>

            @* first row, second column *@
            @* choose time of day drop down menu based on car choice *@
            <td valign="top" width="15%" height="20px">
                    <br />
                @showTimeTitle
                <br />
                @if(allPrice != null){
                @if (ConvertedCarMessage == "Almindelig Vogn")
                    {
                    <select @onchange="HandleTimeChange">
                            <option value="1">[Vælg tid]</option>
                        <option value="1">@allPrice.First(c => c.Id == 1).Tid</option>
                        <option value="2">@allPrice.First(c => c.Id == 2).Tid</option>
                        </select>
                    }
                else if (ConvertedCarMessage == "Stor Vogn - minibus")
                    {
                    <select @onchange="HandleTimeChange">
                            <option value="3">[Vælg tid]</option>
                        <option value="3">@allPrice.First(c => c.Id == 3).Tid</option>
                        <option value="4">@allPrice.First(c => c.Id == 4).Tid</option>
                        </select>
                    }
                    else
                {
                    <select @onchange="HandleTimeChange">
                    <option value="1">[Vælg tid]</option>
                        <option value="1">@allPrice.First(c => c.Id == 1).Tid</option>
                        <option value="2">@allPrice.First(c => c.Id == 2).Tid</option>
                </select>
                }
                }
            </td>

            @* first row, third column *@
            @* choose number of passenger drop down menu. In a standard car, you can only have 6 passengers *@
            <td valign="top" width="15%" height="20px">

                @if (ConvertedCarMessage == "Almindelig Vogn")
                    {
                    <br />

                    @showPassengerTitle

                    <br />
                    <select @onchange="HandlePassengerChange">
                        <option value="0">[Vælg antal]</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                    }
                else
                    {
                    <br />

                    @showPassengerTitle

                    <br />
                    <select @onchange="HandlePassengerChange">
                        <option value="0">[Vælg antal]</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                    }
            </td>

            @* first row, fourth column rowspan 3 *@
            @* get map from google *@
            <td rowspan="3" colspan="2">
                <div style="width: 100%">
                    @* <iframe width="70%" height="200" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?width=100%25&amp;height=600&amp;hl=en&amp;q=Telegrafvej%209+(Tec)&amp;t=&amp;z=14&amp;ie=UTF8&amp;iwloc=B&amp;output=embed"><a href="https://www.gps.ie/">gps vehicle tracker</a></iframe> *@
                    <iframe src="https://www.google.com/maps/embed?pb=!1m28!1m12!1m3!1d35919.143370162!2d12.393316280137304!3d55.759432254864116!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!4m13!3e6!4m5!1s0x46524e6455555555%3A0x72b7451af0607a65!2sMaskinmesterskolen%20K%C3%B8benhavn%2C%20Gyrithe%20Lemches%20Vej%2C%20Kongens%20Lyngby!3m2!1d55.7861183!2d12.5114705!4m5!1s0x46525aecb918d019%3A0xb847ea9201483a5b!2sTelegrafvej%209%2C%202750%20Ballerup!3m2!1d55.7328317!2d12.342666099999999!5e0!3m2!1sda!2sdk!4v1715937359537!5m2!1sda!2sdk" width="600" height="350" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </td>
        </tr>

                @* second row*@
        <tr>
            @* second row, first column *@
            @* choose supplementaries look if they are checked *@
            <td valign="top">
                <br />
                @foreach (var option in Options)
                {
                    <label>
                        <input type="checkbox" @bind="option.IsChecked" /> @option.Label
                    </label>

                    <br />
                }
                <br />

                @if (Options[0].IsChecked == true)
                {
                    string bikeNo = "Antal Cykler:";
                    @bikeNo 
                    <select @onchange="HandleBikeChange">
                        <option value="0">[Vælg antal]</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>           
                }
                else if (Options[0].IsChecked == false)
                {
                    ConvertedBikePrice = 0;
                }

                <br /><br />
                @if (Options[1].IsChecked == true)
                {
                    string upNo = "Antal opbæringer:";
                    @upNo
                    <select @onchange="HandleUpChange">
                        <option value="0">[Vælg antal]</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                }
                else if (Options[1].IsChecked == false)
                {
                    ConvertedUpPrice = 0;
                }

                @if (Options[2].IsChecked == true)
                {
                        AirportPrice = int.Parse(GetTillaegValue("Lufthavn"));
                }
                else if (Options[2].IsChecked == false)
                {
                    AirportPrice = 0;
                }

                @if (Options[3].IsChecked == true)
                {
                    LiftPrice = int.Parse(GetTillaegValue("LiftVogn"));
                }
                else if (Options[3].IsChecked == false)
                {
                    LiftPrice = 0;
                }

                @if (Options[4].IsChecked == true)
                {
                        OeresundPrice = int.Parse(GetTillaegValue("Oeresund"));
                }
                else if (Options[4].IsChecked == false)
                {
                    OeresundPrice = 0;
                }

                @if (Options[5].IsChecked == true)
                {
                        StorebaeltPrice = int.Parse(GetTillaegValue("Storebaelt"));
                }
                else if (Options[5].IsChecked == false)
                {
                    StorebaeltPrice = 0;
                }

            </td>
        </tr>
    </table>
</form>
@* form end *@

@* get distance from user and print out data *@
<table width="100%">
    <tr>
        <td width="15%"></td>
        <td width="15%"></td>
        <td width="15%"></td>
        <td width ="340px">
        <label for="inputField">Skriv distance:</label>
        <br>
            <input type="text" id="inputField" name="inputField" @bind="DistanceValue">
        <br>
        <br>
            <input class="btn btn-primary" type="submit" value="Submit" @onclick="PrintoutData">
            <br>
        </td>
        <td style="align-content:start;">
            <br />
            <span style="border-block:dashed;width:fit-content; font-size:x-large">@SelectedData</span>
        </td>
    </tr>
</table>



@code {

    public List<TaxaService>? allPrice;
    public string showTimeTitle = "Tidspunkt";
    public string showPassengerTitle = "Antal Passagerer";
    public int currentQuestionIndex = 0;
    public TaxaService? currentTaxa;
    // public string? _selectedOption;

    //PROPERTIES
    //Get carprice
    public string? Message { get; set; }
    public string? ConvertedCarMessage { get; set; }
    public string? SelectedTime { get; set; }
    public int SelectedPassenger { get; set; }
    public int MoreThanFour { get; set; }  

    //Supplementary
    public int ConvertedBikePrice { get; set; }
    public int ConvertedUpPrice { get; set; }
    public int AirportPrice { get; set; }
    public int LiftPrice { get; set; }
    public int OeresundPrice { get; set; }
    public int StorebaeltPrice { get; set; }


    //Print out data
    public string? SelectedData { get; set; }
    public string? DistanceValue { get; set; }
    public int SelectedId { get; set; }
    public string? SelectedOptionsText { get; set; }

    public List<CheckBoxOption> Options = new List<CheckBoxOption>
    {
        new CheckBoxOption { IsChecked = false, Label = "Cykel" },
        new CheckBoxOption { IsChecked = false, Label = "Opbæring" },
        new CheckBoxOption { IsChecked = false, Label = "Lufthavn" },
        new CheckBoxOption { IsChecked = false, Label = "Liftvogn" },
        new CheckBoxOption { IsChecked = false, Label = "Øresund" },
        new CheckBoxOption { IsChecked = false, Label = "Storebælt" }
    };

    /// <summary>
    /// Starting up - and getting data from json file
    /// </summary>
    protected override void OnInitialized()
    {
        allPrice = TaxaService.GetJsonData();
        if (allPrice != null)
        {
            currentTaxa = allPrice.FirstOrDefault();
        }

    }
    /// <summary>
    /// Exceptionhandling
    /// </summary>
    /// <param name="carId"></param>
    /// <param name="key"></param>
    /// <returns></returns>
    private string GetKoerselValue(int carId, string key)
    {
        var car = allPrice?.FirstOrDefault(c => c.Id == carId);
        return car?.Koersel != null && car.Koersel.TryGetValue(key, out var value) ? value : "N/A";
    }

    /// <summary>
    /// Exceptionhandling
    /// </summary>
    /// <param name="key"></param>
    /// <returns></returns>
    private string GetTillaegValue(string key)
    {
        return currentTaxa?.Tillaeg != null && currentTaxa.Tillaeg.TryGetValue(key, out var value) ? value : "N/A";
    }

    /// <summary>
    /// Exceptionhandling
    /// </summary>
    /// <param name="id"></param>
    /// <param name="key"></param>
    /// <returns></returns>
    private int GetTillaegValueAsInt(int id, string key)
    {
        var item = allPrice?.FirstOrDefault(m => m.Id == id);
        if (item?.Tillaeg != null && item.Tillaeg.TryGetValue(key, out var value))
        {
            return int.TryParse(value, out int result) ? result : 0;
        }
        return 0;
    }


    public void PrintSelectedOptions()
    {
        var selectedOptions = Options.Where(option => option.IsChecked).Select(option => option.Label);
        SelectedOptionsText = "Selected Options: " + string.Join(", ", selectedOptions);
    }

    public void HandleCarChange(ChangeEventArgs e)
    {
        string? selectedCar = e?.Value?.ToString() ?? "0";
        int selectedCarId = int.Parse(selectedCar);
        if (allPrice != null)
        {
            ConvertedCarMessage = allPrice.First(c => c.Id == selectedCarId).VognType;            
        }
    }

    public void HandleTimeChange(ChangeEventArgs f)
    {
        string? selectedTime = f?.Value?.ToString() ?? "0";
        int convertedTime = int.Parse(selectedTime);
        if (allPrice != null)
        {
            SelectedTime = allPrice.First(c => c.Id == convertedTime).Tid;
        }
    }

    public void HandlePassengerChange(ChangeEventArgs g)
    {
        string? selectedPassenger = g?.Value?.ToString() ?? "0";
        if (selectedPassenger != string.Empty)
        {
            Message = "\tDu valgte: ";
            if (selectedPassenger == "5" || selectedPassenger == "6")
            {
                JSRuntime.InvokeVoidAsync("alert", "Ved mere end 4 passagerer, er der et tillæg på 40 kr.");
                    MoreThanFour = GetTillaegValueAsInt(1, "MereEnd4");

            }
        }
        else
        {
            Message = "";
        }
        SelectedPassenger = int.Parse(selectedPassenger);//TODO Handle hvis passenger er null
    }

    public void HandleBikeChange(ChangeEventArgs h)
    {
        string? selectedBike = h?.Value?.ToString() ?? "0";
        int selectedBikeNo = int.Parse(selectedBike);
        if (allPrice != null)
        {
            ConvertedBikePrice = int.Parse(GetTillaegValue("PrCykel")) * selectedBikeNo;
        }
    }

    public void HandleUpChange(ChangeEventArgs h)
    {
        string? selectedUp = h?.Value?.ToString() ?? "0";
        if (!int.TryParse(selectedUp, out int selectedUpNo))
        {
            selectedUpNo = 0;
        }
        if (allPrice != null)
        {
            ConvertedUpPrice = int.Parse(allPrice?.First()?.Tillaeg?["Opbaering"] ?? "0") * selectedUpNo;
        }
    }

    public void PrintoutData()
    {
        if (ConvertedCarMessage == "Almindelig Vogn")
        {
            if (SelectedTime == "AftenNatHelligdag")
            {
                SelectedId = 2;
            }
            else
            {
                SelectedId = 1;
            }
        }
        else if (ConvertedCarMessage == "Stor Vogn - minibus")
        {
            if (SelectedTime == "AftenNatHelligdag")
            {
                SelectedId = 4;
            }
            else
            {
                SelectedId = 3;
            }
        }
        if (SelectedId != 0 && DistanceValue != null && allPrice != null)
        {
        int startPris = int.Parse(allPrice.FirstOrDefault(car => car.Id == SelectedId).Koersel["StartPris"]);
        decimal kmPris = decimal.Parse(allPrice.FirstOrDefault(car => car.Id == SelectedId).Koersel["KilometerPris"]);
        decimal minutPris = decimal.Parse(allPrice.FirstOrDefault(car => car.Id == SelectedId).Koersel["MinutPris"]);
        decimal distance = decimal.Parse(DistanceValue);

        decimal minuts = distance * 1.2M;
        decimal? turPris = distance * kmPris + minuts * minutPris + startPris + ConvertedBikePrice + ConvertedUpPrice + AirportPrice + LiftPrice + OeresundPrice + StorebaeltPrice + MoreThanFour;
        string selectedData = $"Din tur koster: {turPris:F2} kr.";
        SelectedData = selectedData;
        }
        else if (SelectedId == 0)
        {
            JSRuntime.InvokeVoidAsync("alert", "Vælg vogn");
        }
        else if (DistanceValue == null)
        {
            JSRuntime.InvokeVoidAsync("alert", "Vælg distance. Har du ikke valgt tidspunkt og antal passagerer, vælges dagspris og under 5 passagerer.");
        }

    }
}
